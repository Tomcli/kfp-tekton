name: sendmail
description: |
  This task sends a simple email to receivers via SMTP server
inputs:
  - {name: server, description: 'secret name for SMTP server information (url, port, password)'}
  - {name: subject, description: 'plain text email subject'}
  - {name: body, description: 'plain text email body'}
  - {name: sender, description: 'sender email address'}
  - {name: recipients, description: 'recipient email addresses (space delimited list)'}
implementation:
  container:
    image: docker.io/library/python:3.8-alpine@sha256:c31682a549a3cc0a02f694a29aed07fd252ad05935a8560237aed99b8e87bf77 #tag: 3.8-alpine
    command:
    - python3
    - -u
    - -c
    - |
      #!/usr/bin/env python3
      import smtplib, ssl, os
      port = os.getenv('PORT')
      smtp_server = os.getenv('SERVER')
      sender_email = "$(params.sender)"
      receiver_emails = "$(params.recipients)"
      user = os.getenv('USER')
      password = os.getenv('PASSWORD')
      tls = os.getenv('TLS')
      message = f"""\
      Subject: $(params.subject)
      To: {receiver_emails}
      From: {sender_email}
      $(params.body)"""
      print(message)
      if tls == 'True':
          context = ssl.create_default_context()
          server = smtplib.SMTP_SSL(smtp_server, port, context=context)
      else:
          server = smtplib.SMTP(smtp_server, port)
      if password != '':
          server.login(user, password)
      for receiver in receiver_emails.split(' '):
          server.sendmail(sender_email, receiver, message)
      server.quit()

      import argparse
      _parser = argparse.ArgumentParser('sendmail inputs')
      _parser.add_argument("--server", type=str, required=True)
      _parser.add_argument("--subject", type=str, required=True)
      _parser.add_argument("--body", type=str, required=True)
      _parser.add_argument("--sender", type=str, required=True)
      _parser.add_argument("--recipients", type=str, required=True)
      _parsed_args = vars(_parser.parse_args())
    args: [
      --server, {inputValue: server},
      --subject, {inputValue: subject},
      --body, {inputValue: body},
      --sender, {inputValue: sender},
      --recipients, {inputValue: recipients},
    ]
